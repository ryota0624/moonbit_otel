name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (no actual changes)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # Create or update release PR on every push to main
  # Skipped when the push is a release commit (handled by release job)
  release-pr:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && !(startsWith(github.event.head_commit.message, 'chore:') && contains(github.event.head_commit.message, 'release v')))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Fetch dependencies
        run: moon update

      - name: Install moon-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -fsSL https://raw.githubusercontent.com/dijdzv/moon-release/main/install.sh | bash -s -- 0.3
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry-run }}
        run: |
          DRY_RUN_FLAG=""
          if [ "$DRY_RUN" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          moon-release release-pr $DRY_RUN_FLAG --verbose

  # Create release after release PR is merged
  release:
    if: github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore:') && contains(github.event.head_commit.message, 'release v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Fetch dependencies
        run: moon update

      - name: Install moon-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -fsSL https://raw.githubusercontent.com/dijdzv/moon-release/main/install.sh | bash -s -- 0.3
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      # Configure mooncakes credentials (skip if no token configured)
      - name: Setup mooncakes credentials
        env:
          MOONCAKES_TOKEN: ${{ secrets.MOONCAKES_TOKEN }}
          MOONCAKES_USERNAME: ${{ secrets.MOONCAKES_USERNAME }}
        run: |
          if [ -z "$MOONCAKES_TOKEN" ]; then
            echo "No mooncakes token configured, skipping credentials setup"
            exit 0
          fi
          mkdir -p ~/.moon
          jq -n --arg token "$MOONCAKES_TOKEN" --arg username "$MOONCAKES_USERNAME" \
            '{"token": $token, "username": $username}' > ~/.moon/credentials.json
          chmod 600 ~/.moon/credentials.json

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: moon-release release --verbose
